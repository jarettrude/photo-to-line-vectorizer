---
trigger: always_on
---

# Key Patterns and Best Practices

## ServerFramework Patterns

### Hook System
- Class-level hooks: Apply to ALL methods of a manager
- Method-specific hooks: Target individual methods
- Priority ordering: 1-10 (critical), 11-20 (business), 21-30 (enrichment), 31-40 (logging), 90+ (cleanup)
- Use `@hook_bll` decorator with `HookTiming.BEFORE` or `HookTiming.AFTER`

### Permission System
- SQL-level filtering for performance
- Permission types: VIEW, EXECUTE, COPY, EDIT, DELETE, SHARE
- System users: ROOT_ID, SYSTEM_ID, TEMPLATE_ID
- Hierarchical roles with inheritance
- Team-based permissions

### Database Seeding
- Topological sorting for dependency resolution
- Placeholder field resolution (_extension_name → extension_id)
- Hook-based extensibility
- Model-centric seed data

### Extension System
- Static/abstract classes
- Auto-discovery of providers
- File naming: EXT_*.py, BLL_*.py, PRV_*.py
- Isolated migrations per extension

## ClientFramework Patterns

### Data Fetching
- Use SWR for caching and revalidation
- Custom hooks (useProvider, etc.)
- GraphQL queries via graphql-request
- Real-time subscriptions via graphql-ws

### Component Structure
- Use shadcn/ui components
- Server Components where possible
- Client Components for interactivity
- Proper TypeScript typing

### State Management
- React Context for global state
- SWR for server state
- Cookies for persistent state
- URL state for navigation

### Form Handling
- react-hook-form for state
- Zod for validation
- @hookform/resolvers for integration

## Cross-Framework Patterns

### Type Safety
- Pydantic models (server) → GraphQL types → Zod schemas (client) → TypeScript types
- End-to-end type checking
- Runtime validation at boundaries

### Authentication
- JWT tokens generated by server
- Stored in cookies on client
- Validated by middleware
- Permission context in all operations

### Real-Time Updates
- Server broadcasts via broadcaster
- Client subscribes via graphql-ws
- Event naming: {resource}_{action}
